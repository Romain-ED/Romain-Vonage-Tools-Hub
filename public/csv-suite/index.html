<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Analysis Suite - Romain's Tools Hub</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Minimal custom styles for tab active state */
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        /* Alpine.js x-cloak */
        [x-cloak] {
            display: none !important;
        }

        /* Rakuten-specific styles */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }

        .drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        .terminal-log {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            color: #10b981;
            min-height: 120px;
            max-height: 300px;
            height: auto;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
        }

        .terminal-log::-webkit-scrollbar {
            width: 6px;
        }

        .terminal-log::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 3px;
        }

        .terminal-log::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 3px;
        }

        .stat-card {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        @keyframes progressFill {
            from { width: 0%; }
        }

        .progress-fill {
            animation: progressFill 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .file-preview {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>

    <!-- Alpine.js Component Definition - Must be before body -->
    <script>
        function csvSuite() {
            return {
                activeTab: 'filtering',

                // Rakuten data
                rakuten: {
                    currentPage: 'upload',
                    savedMapping: null,
                    usingSavedMapping: false,
                    rawDataFile: null,
                    didFcFile: null,
                    rawData: null,
                    didFcData: null,
                    rawDataPreview: [],
                    didFcPreview: [],
                    processing: false,
                    progressPercent: 0,
                    progressStatus: 'Initializing...',
                    estimatedTime: 'Calculating...',
                    logs: [],
                    results: null,
                    processedData: null,
                    callsChart: null,
                    durationChart: null,
                    errors: {
                        rawData: '',
                        didFc: ''
                    }
                },

                init() {
                    // Handle URL hash for deep linking
                    const hash = window.location.hash.slice(1);
                    if (hash === 'rakuten' || hash === 'filtering') {
                        this.activeTab = hash;
                    }

                    // Load saved mapping for Rakuten
                    this.loadSavedMapping();

                    // Initialize Rakuten logs
                    this.rakuten.logs = [];
                    this.addRakutenLog('Vonage Rakuten Security Report Builder ready');
                    this.addRakutenLog('Upload your CSV files to begin processing');

                    if (this.rakuten.savedMapping) {
                        this.addRakutenLog(`ðŸ“¦ Found saved mapping: ${this.rakuten.savedMapping.data.length} entries`);
                    }
                },

                switchTab(tab) {
                    this.activeTab = tab;
                    window.location.hash = tab;
                },

                switchRakutenPage(page) {
                    this.rakuten.currentPage = page;
                },

                // Rakuten file handling
                handleRakutenFileSelect(event, fileType) {
                    const file = event.target.files[0];
                    this.processRakutenFile(file, fileType);
                },

                handleRakutenDrop(event, fileType) {
                    const file = event.dataTransfer.files[0];
                    this.processRakutenFile(file, fileType);
                },

                processRakutenFile(file, fileType) {
                    this.clearRakutenError(fileType);

                    if (!file) return;

                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        this.setRakutenError(fileType, 'Only CSV files are allowed');
                        return;
                    }

                    if (file.size > 100 * 1024 * 1024) {
                        this.setRakutenError(fileType, 'File size should be less than 100MB');
                        return;
                    }

                    if (fileType === 'rawData') {
                        this.rakuten.rawDataFile = file;
                        this.addRakutenLog(`Raw data loaded: ${file.name} (${this.formatFileSize(file.size)})`);
                    } else {
                        this.rakuten.didFcFile = file;
                        this.addRakutenLog(`DID/FC reference loaded: ${file.name} (${this.formatFileSize(file.size)})`);
                    }
                },

                // Main Rakuten processing function
                async processRakutenFiles() {
                    if (!this.rakuten.rawDataFile || (!this.rakuten.didFcFile && !this.rakuten.usingSavedMapping && !this.rakuten.didFcData)) {
                        this.addRakutenLog('ERROR: Raw data file and DID/FC reference required', 'error');
                        return;
                    }

                    this.rakuten.processing = true;
                    this.rakuten.results = null;
                    this.addRakutenLog('Starting file processing...');

                    try {
                        // Parse CSV files
                        this.addRakutenLog('Parsing raw data CSV...');
                        this.rakuten.rawData = await this.parseCSV(this.rakuten.rawDataFile);

                        if (this.rakuten.usingSavedMapping) {
                            this.addRakutenLog('Using saved DID/FC mapping...');
                        } else if (this.rakuten.didFcData && !this.rakuten.didFcFile) {
                            this.addRakutenLog('Using pasted DID/FC mapping...');
                        } else {
                            this.addRakutenLog('Parsing DID/FC reference CSV...');
                            this.rakuten.didFcData = await this.parseCSV(this.rakuten.didFcFile);
                        }

                        // Validate and process
                        this.addRakutenLog('Validating data structure...');
                        if (!this.validateRakutenData()) {
                            return;
                        }

                        this.addRakutenLog('Processing records...');
                        const processedData = this.processRakutenData();

                        this.addRakutenLog('Generating analytics...');
                        const analytics = this.generateAnalytics(processedData);

                        this.addRakutenLog('âœ… Processing completed successfully!');

                        this.rakuten.processedData = processedData;
                        this.rakuten.results = {
                            success: true,
                            message: `Successfully processed ${processedData.length} records`,
                            stats: this.generateRakutenStats(processedData),
                            analytics: analytics,
                            preview: processedData.slice(0, 10)
                        };

                        // Generate charts after a short delay to ensure DOM is updated
                        setTimeout(() => {
                            this.createCharts(analytics);
                        }, 100);

                    } catch (error) {
                        this.addRakutenLog(`âŒ Error: ${error.message}`, 'error');
                        this.rakuten.results = {
                            success: false,
                            message: error.message
                        };
                    } finally {
                        this.rakuten.processing = false;
                    }
                },

                // CSV parsing
                parseCSV(file) {
                    return new Promise((resolve, reject) => {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                if (results.errors.length > 0) {
                                    reject(new Error(`CSV parsing error: ${results.errors[0].message}`));
                                } else {
                                    resolve(results.data);
                                }
                            },
                            error: (error) => reject(error)
                        });
                    });
                },

                // Data validation
                validateRakutenData() {
                    const requiredRawColumns = ['account_id', 'direction', 'from', 'to', 'date_start', 'date_end', 'duration'];
                    const requiredDidColumns = ['DID', 'FC'];

                    if (!this.rakuten.rawData || this.rakuten.rawData.length === 0) {
                        this.addRakutenLog('âŒ Raw data is empty', 'error');
                        return false;
                    }

                    if (!this.rakuten.didFcData || this.rakuten.didFcData.length === 0) {
                        this.addRakutenLog('âŒ DID/FC reference data is empty', 'error');
                        return false;
                    }

                    const rawColumns = Object.keys(this.rakuten.rawData[0] || {});
                    const missingRawColumns = requiredRawColumns.filter(col => !rawColumns.includes(col));

                    if (missingRawColumns.length > 0) {
                        this.addRakutenLog(`âŒ Missing columns in raw data: ${missingRawColumns.join(', ')}`, 'error');
                        return false;
                    }

                    const didColumns = Object.keys(this.rakuten.didFcData[0] || {});
                    const missingDidColumns = requiredDidColumns.filter(col => !didColumns.includes(col));

                    if (missingDidColumns.length > 0) {
                        this.addRakutenLog(`âŒ Missing columns in DID/FC reference: ${missingDidColumns.join(', ')}`, 'error');
                        return false;
                    }

                    return true;
                },

                // Data processing
                processRakutenData() {
                    // Create DID to FC mapping
                    const didFcMapping = {};
                    this.rakuten.didFcData.forEach(row => {
                        const did = String(row.DID || '');
                        const fc = row.FC && String(row.FC).trim() !== '' ? String(row.FC) : null;

                        if (!didFcMapping[did]) {
                            didFcMapping[did] = [];
                        }
                        if (fc) {
                            didFcMapping[did].push(fc);
                        }
                    });

                    // Process each record
                    return this.rakuten.rawData.map(row => {
                        const processedRow = {
                            account_id: row.account_id || '',
                            direction: row.direction || '',
                            from: row.from || '',
                            to: row.to || '',
                            date_start: row.date_start || '',
                            date_end: row.date_end || '',
                            duration: row.duration || ''
                        };

                        // Add Originate classification
                        processedRow.Originate = this.classifyOriginate(row.from);

                        // Add Terminate classification
                        processedRow.Terminate = this.classifyTerminate(row.to, didFcMapping);

                        // Add FC columns
                        const fcValues = this.getFcValues(row.to, didFcMapping);
                        processedRow.FC = fcValues[0];
                        processedRow.FC2 = fcValues[1];
                        processedRow.FC3 = fcValues[2];

                        return processedRow;
                    });
                },

                // Classification functions
                classifyOriginate(fromNumber) {
                    if (!fromNumber || fromNumber === '') return '';

                    const fromStr = String(fromNumber).toLowerCase();

                    if (fromStr === 'coinline/payphone') return 'Anonymous';
                    if (fromStr.startsWith('81800')) return 'Toll Free';
                    if (fromStr.startsWith('8170') || fromStr.startsWith('8180') || fromStr.startsWith('8190')) return 'Mobile';
                    if (fromStr.startsWith('ano')) return 'Anonymous';
                    if (fromStr.startsWith('81')) return 'Fixed';

                    return "Int'l";
                },

                classifyTerminate(toNumber, didFcMapping) {
                    if (!toNumber || toNumber === '') return 'Landline';

                    const toStr = String(toNumber);
                    if (toStr in didFcMapping && didFcMapping[toStr].length > 0) {
                        return 'TFN Bundle';
                    }

                    return 'Landline';
                },

                getFcValues(toNumber, didFcMapping) {
                    if (!toNumber) return ['NA', 'NA', 'NA'];

                    const fcList = didFcMapping[String(toNumber)] || [];

                    if (fcList.length === 0) return ['NA', 'NA', 'NA'];

                    // Prioritize 0120-prefixed FCs
                    const fc0120 = fcList.filter(fc => String(fc).startsWith('0120'));
                    const fcOthers = fcList.filter(fc => !String(fc).startsWith('0120'));

                    const prioritizedList = [...fc0120, ...fcOthers];

                    return [
                        prioritizedList[0] || 'NA',
                        prioritizedList[1] || 'NA',
                        prioritizedList[2] || 'NA'
                    ];
                },

                // Analytics generation
                generateAnalytics(processedData) {
                    const fcAnalytics = {};

                    // Process FC, FC2, FC3 columns
                    ['FC', 'FC2', 'FC3'].forEach(fcCol => {
                        processedData.forEach(row => {
                            const fc = row[fcCol];
                            if (fc && fc !== 'NA') {
                                if (!fcAnalytics[fc]) {
                                    fcAnalytics[fc] = { calls: 0, totalDuration: 0 };
                                }
                                fcAnalytics[fc].calls += 1;
                                fcAnalytics[fc].totalDuration += parseFloat(row.duration) || 0;
                            }
                        });
                    });

                    const fcArray = Object.entries(fcAnalytics)
                        .map(([fc, data]) => ({
                            FC: fc,
                            calls: data.calls,
                            durationHours: data.totalDuration / 3600
                        }))
                        .sort((a, b) => b.calls - a.calls);

                    return {
                        totalUniqueFCs: fcArray.length,
                        totalCalls: fcArray.reduce((sum, fc) => sum + fc.calls, 0),
                        totalDurationHours: fcArray.reduce((sum, fc) => sum + fc.durationHours, 0),
                        topFCs: fcArray.slice(0, 5)
                    };
                },

                generateRakutenStats(processedData) {
                    const originateDistribution = {};
                    const terminateDistribution = {};
                    const durationMatrix = {};

                    processedData.forEach(row => {
                        const originate = row.Originate;
                        const terminate = row.Terminate;
                        const duration = parseInt(row.duration) || 0;

                        originateDistribution[originate] = (originateDistribution[originate] || 0) + 1;
                        terminateDistribution[terminate] = (terminateDistribution[terminate] || 0) + 1;

                        // Build duration cross-tabulation matrix
                        if (!durationMatrix[originate]) {
                            durationMatrix[originate] = {};
                        }
                        durationMatrix[originate][terminate] = (durationMatrix[originate][terminate] || 0) + duration;
                    });

                    return {
                        totalRecords: processedData.length,
                        originateDistribution,
                        terminateDistribution,
                        durationMatrix
                    };
                },

                // Download functionality
                downloadRakutenCSV() {
                    if (!this.rakuten.processedData) return;

                    const csv = Papa.unparse(this.rakuten.processedData);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `rakuten_processed_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    this.addRakutenLog('ðŸ“¥ CSV file downloaded successfully');
                },

                // Chart generation
                createCharts(analytics) {
                    if (!analytics || !analytics.topFCs || analytics.topFCs.length === 0) return;

                    this.destroyCharts();

                    const topFCs = analytics.topFCs.slice(0, 5);
                    const labels = topFCs.map(fc => fc.FC);
                    const callsData = topFCs.map(fc => fc.calls);
                    const durationData = topFCs.map(fc => fc.durationHours.toFixed(1));

                    // Chart.js configuration for dark theme
                    const darkTheme = {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e5e7eb'
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: '#4b5563'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: '#4b5563'
                                }
                            }
                        }
                    };

                    // Calls Chart
                    const callsCtx = document.getElementById('callsChart');
                    if (callsCtx) {
                        this.rakuten.callsChart = new Chart(callsCtx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Number of Calls',
                                    data: callsData,
                                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                ...darkTheme,
                                plugins: {
                                    ...darkTheme.plugins,
                                    title: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }

                    // Duration Chart
                    const durationCtx = document.getElementById('durationChart');
                    if (durationCtx) {
                        this.rakuten.durationChart = new Chart(durationCtx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Duration (Hours)',
                                    data: durationData,
                                    backgroundColor: [
                                        'rgba(34, 197, 94, 0.8)',
                                        'rgba(59, 130, 246, 0.8)',
                                        'rgba(251, 191, 36, 0.8)',
                                        'rgba(239, 68, 68, 0.8)',
                                        'rgba(168, 85, 247, 0.8)'
                                    ],
                                    borderColor: [
                                        'rgba(34, 197, 94, 1)',
                                        'rgba(59, 130, 246, 1)',
                                        'rgba(251, 191, 36, 1)',
                                        'rgba(239, 68, 68, 1)',
                                        'rgba(168, 85, 247, 1)'
                                    ],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            color: '#e5e7eb',
                                            padding: 10
                                        }
                                    }
                                }
                            }
                        });
                    }

                    this.addRakutenLog('ðŸ“Š Interactive charts generated');
                },

                destroyCharts() {
                    if (this.rakuten.callsChart) {
                        this.rakuten.callsChart.destroy();
                        this.rakuten.callsChart = null;
                    }
                    if (this.rakuten.durationChart) {
                        this.rakuten.durationChart.destroy();
                        this.rakuten.durationChart = null;
                    }
                },

                // Utility functions
                addRakutenLog(message, type = 'info') {
                    const timestamp = new Date().toLocaleTimeString();
                    this.rakuten.logs.push({
                        id: Date.now(),
                        timestamp,
                        message,
                        type
                    });

                    // Auto-scroll terminal
                    this.$nextTick(() => {
                        const terminal = document.querySelector('.terminal-log');
                        if (terminal) {
                            terminal.scrollTop = terminal.scrollHeight;
                        }
                    });
                },

                setRakutenError(fileType, message) {
                    this.rakuten.errors[fileType] = message;
                    if (fileType === 'rawData') this.rakuten.rawDataFile = null;
                    else this.rakuten.didFcFile = null;
                },

                clearRakutenError(fileType) {
                    this.rakuten.errors[fileType] = '';
                },

                // Mapping Management Functions
                loadSavedMapping() {
                    try {
                        const saved = localStorage.getItem('didFcMapping');
                        if (saved) {
                            this.rakuten.savedMapping = JSON.parse(saved);
                        }
                    } catch (error) {
                        console.error('Error loading saved mapping:', error);
                        localStorage.removeItem('didFcMapping');
                    }
                },

                async saveMapping() {
                    if (!this.rakuten.didFcFile) {
                        this.addRakutenLog('No DID/FC file to save', 'error');
                        return;
                    }

                    try {
                        this.addRakutenLog('Saving DID/FC mapping...');

                        // Read and parse the file
                        const text = await this.rakuten.didFcFile.text();
                        const parsed = Papa.parse(text, {
                            header: true,
                            skipEmptyLines: true
                        });

                        if (parsed.errors.length > 0) {
                            this.addRakutenLog('Error parsing DID/FC file', 'error');
                            return;
                        }

                        // Create mapping object
                        const mapping = {
                            savedAt: new Date().toLocaleString(),
                            fileName: this.rakuten.didFcFile.name,
                            fileSize: this.formatFileSize(this.rakuten.didFcFile.size),
                            data: parsed.data
                        };

                        // Save to localStorage
                        localStorage.setItem('didFcMapping', JSON.stringify(mapping));
                        this.rakuten.savedMapping = mapping;

                        this.addRakutenLog(`âœ… Mapping saved: ${mapping.data.length} entries`, 'success');

                    } catch (error) {
                        this.addRakutenLog('Failed to save mapping: ' + error.message, 'error');
                    }
                },

                useSavedMapping() {
                    if (!this.rakuten.savedMapping) return;

                    this.rakuten.usingSavedMapping = true;
                    this.rakuten.didFcFile = null;
                    this.rakuten.didFcData = this.rakuten.savedMapping.data;
                    this.rakuten.didFcPreview = this.rakuten.savedMapping.data.slice(0, 5);

                    this.addRakutenLog(`Using saved mapping: ${this.rakuten.savedMapping.data.length} entries`, 'success');
                },

                clearSavedMapping() {
                    this.rakuten.usingSavedMapping = false;
                    this.rakuten.didFcFile = null;
                    this.rakuten.didFcData = null;
                    this.rakuten.didFcPreview = [];

                    this.addRakutenLog('Cleared saved mapping selection');
                },

                deleteSavedMapping() {
                    if (!confirm('Are you sure you want to delete the saved mapping? This action cannot be undone.')) {
                        return;
                    }

                    localStorage.removeItem('didFcMapping');
                    this.rakuten.savedMapping = null;
                    this.rakuten.usingSavedMapping = false;
                    this.rakuten.didFcData = null;
                    this.rakuten.didFcPreview = [];

                    this.addRakutenLog('Saved mapping deleted', 'info');
                },

                downloadMapping() {
                    if (!this.rakuten.savedMapping) return;

                    const csv = Papa.unparse(this.rakuten.savedMapping.data);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');

                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `did_fc_mapping_${new Date().toISOString().slice(0, 10)}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }

                    this.addRakutenLog('Mapping downloaded as CSV');
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="csvSuite()">
    <!-- Navigation Header -->
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-table text-blue-400 text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold text-white">CSV Analysis Suite</h1>
                        <p class="text-xs text-gray-400">Report Filtering & Rakuten Security Analysis v3.1.1</p>
                    </div>
                </div>
                <a href="/" class="text-gray-300 hover:text-blue-400 transition-colors px-3 py-2 rounded-md">
                    <i class="fas fa-home mr-2"></i>Back to Hub
                </a>
            </div>
        </div>
    </nav>

    <!-- Tab Navigation -->
    <div class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <button
                    @click="switchTab('filtering')"
                    class="px-4 py-4 text-sm font-medium transition-colors hover:text-blue-400"
                    :class="activeTab === 'filtering' ? 'tab-active' : 'text-gray-400'"
                >
                    <i class="fas fa-filter mr-2"></i>Report Filtering
                </button>
                <button
                    @click="switchTab('rakuten')"
                    class="px-4 py-4 text-sm font-medium transition-colors hover:text-blue-400"
                    :class="activeTab === 'rakuten' ? 'tab-active' : 'text-gray-400'"
                >
                    <i class="fas fa-shield-alt mr-2"></i>Rakuten Analysis
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filtering Tab -->
        <div :class="activeTab === 'filtering' ? '' : 'hidden'" id="filteringTab">
            <!-- Filtering tool content will be here -->
            <div class="space-y-6">
                <!-- Upload Section -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold text-white mb-4">
                        <i class="fas fa-cloud-upload-alt mr-2 text-blue-400"></i>Upload CSV File
                    </h2>
                    <div id="uploadArea" class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer bg-gray-700">
                        <div class="upload-icon text-4xl mb-4">ðŸ“„</div>
                        <h3 class="text-lg font-medium text-gray-300 mb-2">Drop your CSV file here or click to browse</h3>
                        <p class="text-sm text-gray-500">Supports large CSV files</p>
                        <input type="file" id="csvFile" accept=".csv" class="hidden">
                    </div>
                </div>

                <!-- File Info Section -->
                <div id="fileInfoSection" class="bg-gray-800 rounded-lg border border-gray-700 p-6" style="display: none;">
                    <h2 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-400"></i>File Information
                    </h2>
                    <div id="fileInfoGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- File info will be populated here -->
                    </div>
                </div>

                <!-- Analysis Section -->
                <div id="analysisSection" class="bg-gray-800 rounded-lg border border-gray-700 p-6" style="display: none;">
                    <h2 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-chart-bar mr-2 text-green-400"></i>File Analysis
                    </h2>
                    <p class="text-gray-400 mb-4">Select headers to analyze and view the top 10 most common values for each column.</p>

                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-300 mb-3">Select Headers to Analyze</h3>
                            <div id="headerCheckboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <!-- Dynamic header checkboxes will be added here -->
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button id="analyzeBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                                <i class="fas fa-chart-line mr-2"></i>Analyze Selected Headers
                            </button>
                            <button id="clearAnalysisBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                <i class="fas fa-eraser mr-2"></i>Clear Analysis
                            </button>
                        </div>
                    </div>

                    <div id="analysisResults" class="mt-6" style="display: none;">
                        <h3 class="text-lg font-medium text-white mb-3">Analysis Results</h3>
                        <div id="analysisGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Analysis results will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div id="filterSection" class="bg-gray-800 rounded-lg border border-gray-700 p-6" style="display: none;">
                    <h2 class="text-xl font-bold text-white mb-4">
                        <i class="fas fa-filter mr-2 text-red-400"></i>Filter Options
                    </h2>
                    <div id="filtersContainer" class="space-y-4 mb-4">
                        <!-- Dynamic filter controls will be added here -->
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center space-x-3 text-gray-300">
                            <input type="checkbox" id="removeInternalFieldsCheckbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            <div>
                                <span class="font-medium">Remove Internal Fields</span>
                                <p class="text-sm text-gray-500">Hide technical columns (route_cost, hlr_lookup_cost, gateway, etc.)</p>
                            </div>
                        </label>
                    </div>
                    <div class="flex gap-3">
                        <button id="addFilterBtn" class="bg-purple-600 hover:bg-purple-500 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Filter (Ctrl+F)
                        </button>
                        <button id="applyFiltersBtn" class="bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                            <i class="fas fa-check mr-2"></i>Apply Filters (Ctrl+Enter)
                        </button>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="bg-gray-800 rounded-lg border border-gray-700 p-6" style="display: none;">
                    <div class="mb-4">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h2 class="text-xl font-bold text-white">
                                <i class="fas fa-table mr-2 text-yellow-400"></i>Results
                            </h2>
                            <div class="flex flex-wrap gap-3">
                                <input type="text" id="searchWithinResults" placeholder="Search within results..." class="bg-gray-700 text-gray-100 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500">
                                <span class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">
                                    <span id="totalRows">0</span> rows found
                                </span>
                                <button id="showAllResultsBtn" onclick="csvTool.showAllResults()" style="display: none;" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded-lg text-sm transition-colors" title="Show all matching results without 50-row limit">
                                    <i class="fas fa-sync-alt mr-1"></i>Show All
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="csvTool.downloadData('csv')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-csv mr-2"></i>Download CSV
                            </button>
                            <button onclick="csvTool.downloadData('json')" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-code mr-2"></i>Download JSON
                            </button>
                            <button onclick="csvTool.downloadData('excel')" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-excel mr-2"></i>Download Excel
                            </button>
                        </div>
                    </div>
                    <div id="resultsFileInfo" class="mb-4 bg-gray-700 rounded-lg p-4" style="display: none;">
                        <h3 class="text-lg font-medium text-white mb-3">
                            <i class="fas fa-chart-pie mr-2"></i>Output File Information
                        </h3>
                        <div id="resultsFileInfoGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Results file info will be populated here -->
                        </div>
                    </div>
                    <div class="relative">
                        <div class="overflow-x-auto overflow-y-auto bg-gray-700 rounded-lg border border-gray-600 max-h-[600px] shadow-inner">
                            <table id="resultsTable" class="min-w-full divide-y divide-gray-600">
                                <thead id="tableHead" class="bg-gray-800 sticky top-0 z-20 shadow-md"></thead>
                                <tbody id="tableBody" class="divide-y divide-gray-700 bg-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-xs text-gray-400 text-center">
                            <i class="fas fa-info-circle mr-1"></i>Scroll horizontally to view more columns
                        </div>
                    </div>
                    <div id="pagination" class="mt-6"></div>
                </div>

                <!-- Log Section -->
                <div id="logSection" class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white">
                            <i class="fas fa-terminal mr-2 text-green-400"></i>Processing Log
                        </h2>
                        <div class="flex gap-2">
                            <button id="clearLogBtn" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-1 rounded transition-colors">
                                <i class="fas fa-trash mr-1"></i>Clear
                            </button>
                            <button id="toggleLogBtn" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-1 rounded transition-colors">
                                <i class="fas fa-eye-slash mr-1"></i>Hide
                            </button>
                            <button id="exportLogBtn" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-3 py-1 rounded transition-colors">
                                <i class="fas fa-download mr-1"></i>Export
                            </button>
                        </div>
                    </div>
                    <div id="logContainer" class="bg-gray-900 rounded-lg p-4 font-mono text-sm text-green-400 min-h-32 max-h-64 overflow-y-auto">
                        <div class="text-gray-500">
                            <span class="text-gray-400">Ready</span> - CSV Filter Tool initialized. Upload a file to begin.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rakuten Tab -->
        <div :class="activeTab === 'rakuten' ? '' : 'hidden'">
            <!-- Sub-navigation for Rakuten pages -->
            <div class="mb-6 flex items-center space-x-4 bg-gray-800 rounded-lg border border-gray-700 p-4">
                <button @click="switchRakutenPage('upload')"
                       :class="rakuten.currentPage === 'upload' ? 'text-blue-400 bg-blue-900' : 'text-gray-300 hover:text-blue-400'"
                       class="px-3 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-upload mr-2"></i>Upload
                </button>
                <button @click="switchRakutenPage('mappings')"
                       :class="rakuten.currentPage === 'mappings' ? 'text-blue-400 bg-blue-900' : 'text-gray-300 hover:text-blue-400'"
                       class="px-3 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-database mr-2"></i>DID/FC Mapping
                    <span x-show="rakuten.savedMapping" class="ml-1 bg-green-500 text-white text-xs px-1 py-0.5 rounded-full">1</span>
                </button>
                <button @click="switchRakutenPage('docs')"
                       :class="rakuten.currentPage === 'docs' ? 'text-blue-400 bg-blue-900' : 'text-gray-300 hover:text-blue-400'"
                       class="px-3 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-book mr-2"></i>Documentation
                </button>
            </div>

            <!-- Upload Page -->
            <div x-show="rakuten.currentPage === 'upload'" class="space-y-6">
                <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">
                        <i class="fas fa-cloud-upload-alt mr-2 text-blue-400"></i>Upload Files
                    </h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Raw Data Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Raw Data CSV</label>
                            <div @drop.prevent="handleRakutenDrop($event, 'rawData')"
                                 @dragover.prevent @dragenter.prevent
                                 class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer bg-gray-700"
                                 :class="{ 'border-blue-400 bg-blue-900/20': rakuten.rawDataFile, 'border-red-400 bg-red-900/20': rakuten.errors.rawData }"
                                 @click="document.getElementById('rawDataInput').click()">
                                <input type="file" id="rawDataInput" @change="handleRakutenFileSelect($event, 'rawData')" accept=".csv" class="hidden">
                                <div x-show="!rakuten.rawDataFile">
                                    <i class="fas fa-file-csv text-4xl text-gray-400 mb-4"></i>
                                    <p class="text-gray-300">Drop your raw data CSV here or click to browse</p>
                                    <p class="text-sm text-gray-500 mt-2">Max recommended size: 100MB</p>
                                </div>
                                <div x-show="rakuten.rawDataFile" class="text-green-400">
                                    <i class="fas fa-check-circle text-2xl mb-2"></i>
                                    <p x-text="rakuten.rawDataFile?.name" class="font-medium"></p>
                                    <p class="text-sm text-gray-400" x-text="formatFileSize(rakuten.rawDataFile?.size)"></p>
                                </div>
                            </div>
                            <div x-show="rakuten.errors.rawData" class="text-red-400 text-sm mt-1" x-text="rakuten.errors.rawData"></div>

                            <!-- File Preview -->
                            <div x-show="rakuten.rawDataPreview.length > 0" class="mt-4 fade-in">
                                <h4 class="text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-eye mr-1"></i>Preview (First 5 rows)
                                </h4>
                                <div class="file-preview p-3">
                                    <div class="text-xs font-mono">
                                        <div class="text-blue-400 mb-1" x-text="'Columns: ' + (rakuten.rawDataPreview[0] ? Object.keys(rakuten.rawDataPreview[0]).join(', ') : '')"></div>
                                        <template x-for="(row, index) in rakuten.rawDataPreview.slice(0, 3)" :key="index">
                                            <div class="text-gray-300 truncate" x-text="JSON.stringify(row).substring(0, 100) + '...'"></div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DID/FC Reference Upload -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-300">DID/FC Reference</label>
                                <div class="flex space-x-2">
                                    <button x-show="rakuten.savedMapping && !rakuten.usingSavedMapping"
                                           @click="useSavedMapping()"
                                           class="text-xs bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded transition-colors">
                                        <i class="fas fa-database mr-1"></i>Use Saved Mapping
                                    </button>
                                </div>
                            </div>

                            <!-- Saved Mapping Display -->
                            <div x-show="rakuten.usingSavedMapping" class="mb-4 p-4 bg-green-900/30 border border-green-700 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center text-green-300 font-medium mb-1">
                                            <i class="fas fa-check-circle mr-2"></i>Using Saved Mapping
                                        </div>
                                        <div class="text-sm text-gray-300">
                                            <div>Saved: <span x-text="rakuten.savedMapping?.savedAt"></span></div>
                                            <div>Entries: <span x-text="rakuten.savedMapping?.data?.length || 0"></span></div>
                                        </div>
                                    </div>
                                    <button @click="clearSavedMapping()"
                                           class="text-xs text-gray-400 hover:text-red-400 transition-colors">
                                        <i class="fas fa-times mr-1"></i>Upload New
                                    </button>
                                </div>
                            </div>

                            <!-- File Upload Area -->
                            <div x-show="!rakuten.usingSavedMapping">
                                <div @drop.prevent="handleRakutenDrop($event, 'didFc')"
                                     @dragover.prevent @dragenter.prevent
                                     class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer bg-gray-700"
                                     :class="{ 'border-blue-400 bg-blue-900/20': rakuten.didFcFile, 'border-red-400 bg-red-900/20': rakuten.errors.didFc }"
                                     @click="document.getElementById('didFcInput').click()">
                                    <input type="file" id="didFcInput" @change="handleRakutenFileSelect($event, 'didFc')" accept=".csv" class="hidden">
                                    <div x-show="!rakuten.didFcFile">
                                        <i class="fas fa-file-csv text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-gray-300">Drop your DID/FC reference CSV here or click to browse</p>
                                        <div x-show="rakuten.savedMapping" class="mt-2 text-xs text-green-400">
                                            ðŸ’¡ Or use the "Use Saved Mapping" button above
                                        </div>
                                    </div>
                                    <div x-show="rakuten.didFcFile" class="text-green-400">
                                        <i class="fas fa-check-circle text-2xl mb-2"></i>
                                        <p x-text="rakuten.didFcFile?.name" class="font-medium"></p>
                                        <p class="text-sm text-gray-400" x-text="formatFileSize(rakuten.didFcFile?.size)"></p>
                                        <button @click.stop="saveMapping()"
                                               class="mt-2 text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors">
                                            <i class="fas fa-save mr-1"></i>Save This Mapping
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div x-show="rakuten.errors.didFc" class="text-red-400 text-sm mt-1" x-text="rakuten.errors.didFc"></div>

                            <!-- File Preview -->
                            <div x-show="rakuten.didFcPreview.length > 0" class="mt-4 fade-in">
                                <h4 class="text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-eye mr-1"></i>Preview (First 5 rows)
                                </h4>
                                <div class="file-preview p-3">
                                    <div class="text-xs font-mono">
                                        <div class="text-blue-400 mb-1" x-text="'Columns: ' + (rakuten.didFcPreview[0] ? Object.keys(rakuten.didFcPreview[0]).join(', ') : '')"></div>
                                        <template x-for="(row, index) in rakuten.didFcPreview.slice(0, 3)" :key="index">
                                            <div class="text-gray-300 truncate" x-text="JSON.stringify(row).substring(0, 100) + '...'"></div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Process Button and Progress -->
                    <div class="flex flex-col items-center space-y-4">
                        <!-- Progress Bar -->
                        <div x-show="rakuten.processing" class="w-full max-w-md fade-in">
                            <div class="flex justify-between text-sm text-gray-400 mb-2">
                                <span x-text="rakuten.progressStatus"></span>
                                <span x-text="rakuten.progressPercent + '%'"></span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full progress-fill transition-all duration-300"
                                     :style="'width: ' + rakuten.progressPercent + '%'"></div>
                            </div>
                            <div class="text-center text-xs text-gray-400 mt-2">
                                <span x-text="'Estimated time remaining: ' + rakuten.estimatedTime"></span>
                            </div>
                        </div>

                        <!-- Process Button -->
                        <button @click="processRakutenFiles()"
                                :disabled="!rakuten.rawDataFile || (!rakuten.didFcFile && !rakuten.usingSavedMapping) || rakuten.processing"
                                class="bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium py-2 px-6 rounded-lg transition-all duration-200 flex items-center transform hover:scale-105">
                            <i :class="rakuten.processing ? 'fas fa-spinner fa-spin' : 'fas fa-play'" class="mr-2"></i>
                            <span x-text="rakuten.processing ? 'Processing...' : 'Process Files'"></span>
                        </button>
                    </div>
                </div>

                <!-- Processing Log -->
                <div x-show="true" class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6 fade-in">
                    <h3 class="text-lg font-semibold text-white mb-4">
                        <i class="fas fa-terminal mr-2 text-green-400"></i>Processing Log
                        <span class="text-xs text-gray-400">(<span x-text="rakuten.logs.length"></span> entries)</span>
                        <button @click="rakuten.logs = []" class="float-right text-xs text-gray-400 hover:text-white">
                            <i class="fas fa-trash mr-1"></i>Clear
                        </button>
                    </h3>
                    <div class="terminal-log">
                        <div x-show="rakuten.logs.length === 0" class="text-gray-500 text-center py-4 italic">
                            No log entries yet. Upload files to see logs here.
                        </div>
                        <div x-show="rakuten.logs.length > 0">
                            <template x-for="(log, index) in rakuten.logs" :key="index">
                                <div class="mb-2 leading-relaxed text-green-300">
                                    <span class="text-gray-400 mr-3 font-mono text-xs" x-text="log.timestamp || 'N/A'"></span>
                                    <span x-text="log.message || 'Empty log'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div x-show="rakuten.results" class="space-y-6">
                    <!-- Success/Error Message -->
                    <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
                        <div x-show="rakuten.results?.success" class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">
                                <i class="fas fa-check-circle mr-2 text-green-400"></i>Processing Complete
                            </h3>
                            <button @click="downloadRakutenCSV()"
                                   class="bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-download mr-2"></i>Download CSV
                            </button>
                        </div>
                        <div x-show="!rakuten.results?.success" class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
                            <h3 class="text-lg font-semibold text-red-300">Processing Error</h3>
                        </div>
                        <p x-text="rakuten.results?.message" :class="rakuten.results?.success ? 'text-gray-300' : 'text-red-300'"></p>
                    </div>

                    <!-- Statistics -->
                    <div x-show="rakuten.results?.success && rakuten.results?.stats" class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-chart-bar mr-2 text-blue-400"></i>Processing Statistics
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="stat-card bg-blue-900/50 border border-blue-700 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-blue-400" x-text="rakuten.results?.stats?.totalRecords?.toLocaleString()"></div>
                                <div class="text-sm text-blue-300">Total Records</div>
                            </div>
                            <div class="stat-card bg-green-900/50 border border-green-700 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-green-400" x-text="Object.keys(rakuten.results?.stats?.originateDistribution || {}).length"></div>
                                <div class="text-sm text-green-300">Originate Types</div>
                            </div>
                            <div class="stat-card bg-purple-900/50 border border-purple-700 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-purple-400" x-text="Object.keys(rakuten.results?.stats?.terminateDistribution || {}).length"></div>
                                <div class="text-sm text-purple-300">Terminate Types</div>
                            </div>
                        </div>
                    </div>

                    <!-- Duration Matrix -->
                    <div x-show="rakuten.results?.success && rakuten.results?.stats?.durationMatrix" class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-table mr-2 text-cyan-400"></i>Call Duration Matrix (Originate Ã— Terminate)
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr class="bg-gray-700">
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                            Originate â†’ Terminate
                                        </th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-cyan-300 uppercase tracking-wider">
                                            Landline
                                        </th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-cyan-300 uppercase tracking-wider">
                                            TFN Bundle
                                        </th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-blue-300 uppercase tracking-wider border-l border-gray-600">
                                            Total
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    <template x-for="originate in ['Mobile', 'Toll Free', 'Anonymous', 'Fixed', 'Int\'l']" :key="originate">
                                        <tr class="hover:bg-gray-750">
                                            <td class="px-4 py-3 text-sm font-medium text-gray-300" x-text="originate"></td>
                                            <td class="px-4 py-3 text-sm text-center text-gray-300 font-mono">
                                                <span x-text="((rakuten.results?.stats?.durationMatrix[originate]?.['Landline'] || 0)).toLocaleString() + ' sec'"></span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-center text-gray-300 font-mono">
                                                <span x-text="((rakuten.results?.stats?.durationMatrix[originate]?.['TFN Bundle'] || 0)).toLocaleString() + ' sec'"></span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-center text-blue-400 font-mono font-semibold border-l border-gray-600">
                                                <span x-text="(((rakuten.results?.stats?.durationMatrix[originate]?.['Landline'] || 0) + (rakuten.results?.stats?.durationMatrix[originate]?.['TFN Bundle'] || 0))).toLocaleString() + ' sec'"></span>
                                            </td>
                                        </tr>
                                    </template>
                                    <!-- Total Row -->
                                    <tr class="bg-gray-750 font-semibold border-t-2 border-gray-600">
                                        <td class="px-4 py-3 text-sm text-gray-200">Total</td>
                                        <td class="px-4 py-3 text-sm text-center text-cyan-400 font-mono">
                                            <span x-text="(Object.values(rakuten.results?.stats?.durationMatrix || {}).reduce((sum, row) => sum + (row['Landline'] || 0), 0)).toLocaleString() + ' sec'"></span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-center text-cyan-400 font-mono">
                                            <span x-text="(Object.values(rakuten.results?.stats?.durationMatrix || {}).reduce((sum, row) => sum + (row['TFN Bundle'] || 0), 0)).toLocaleString() + ' sec'"></span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-center text-blue-400 font-mono font-bold border-l border-gray-600">
                                            <span x-text="(Object.values(rakuten.results?.stats?.durationMatrix || {}).reduce((sum, row) => sum + (row['Landline'] || 0) + (row['TFN Bundle'] || 0), 0)).toLocaleString() + ' sec'"></span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>Total duration in seconds for each Originate and Terminate combination
                        </div>
                    </div>

                    <!-- Analytics -->
                    <div x-show="rakuten.results?.analytics" class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6 fade-in">
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-chart-pie mr-2 text-orange-400"></i>FC Analytics Summary
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="stat-card bg-orange-900/50 border border-orange-700 p-4 rounded-lg transform hover:scale-105 transition-transform">
                                <div class="text-2xl font-bold text-orange-400" x-text="rakuten.results?.analytics?.totalUniqueFCs"></div>
                                <div class="text-sm text-orange-300">Unique Free Call Codes</div>
                            </div>
                            <div class="stat-card bg-blue-900/50 border border-blue-700 p-4 rounded-lg transform hover:scale-105 transition-transform">
                                <div class="text-2xl font-bold text-blue-400" x-text="rakuten.results?.analytics?.totalCalls?.toLocaleString()"></div>
                                <div class="text-sm text-blue-300">Total Calls</div>
                            </div>
                            <div class="stat-card bg-green-900/50 border border-green-700 p-4 rounded-lg transform hover:scale-105 transition-transform">
                                <div class="text-2xl font-bold text-green-400" x-text="rakuten.results?.analytics?.totalDurationHours?.toFixed(2)"></div>
                                <div class="text-sm text-green-300">Total Hours</div>
                            </div>
                        </div>

                        <!-- Interactive Charts -->
                        <div x-show="rakuten.results?.analytics?.topFCs?.length > 0" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="font-medium text-white mb-3 text-center">Top Free Call Codes by Calls</h4>
                                <canvas id="callsChart" class="max-h-64"></canvas>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="font-medium text-white mb-3 text-center">Top Free Call Codes by Duration</h4>
                                <canvas id="durationChart" class="max-h-64"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mappings Page -->
            <div x-show="rakuten.currentPage === 'mappings'" class="space-y-8">
                <div class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">
                        <i class="fas fa-database mr-2 text-blue-400"></i>DID/FC Mapping Management
                    </h2>

                    <!-- Information Box -->
                    <div class="bg-blue-900/30 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-blue-300 font-medium mb-1">How Mapping Storage Works</h3>
                                <p class="text-blue-200 text-sm">
                                    Your DID/FC mappings are saved securely in your browser's local storage. This means:
                                </p>
                                <ul class="text-blue-200 text-sm mt-2 space-y-1">
                                    <li>â€¢ <strong>Privacy-focused:</strong> Data never leaves your computer or browser</li>
                                    <li>â€¢ <strong>Persistent:</strong> Mappings remain saved even after closing the browser</li>
                                    <li>â€¢ <strong>Browser-specific:</strong> Each browser stores its own copy of your mappings</li>
                                    <li>â€¢ <strong>One mapping limit:</strong> Only one DID/FC mapping can be stored at a time</li>
                                    <li>â€¢ <strong>Backup recommended:</strong> Use "Download as CSV" to backup your mappings</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Current Mapping Status -->
                    <div x-show="!rakuten.savedMapping" class="bg-gray-700 rounded-lg p-6 text-center">
                        <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-white mb-2">No Saved Mapping</h3>
                        <p class="text-gray-300 mb-4">Create your first DID/FC mapping by uploading a file on the Upload page.</p>
                        <div class="flex justify-center space-x-3">
                            <button @click="switchRakutenPage('upload')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors">
                                <i class="fas fa-upload mr-2"></i>Go to Upload
                            </button>
                        </div>
                    </div>

                    <!-- Saved Mapping Display -->
                    <div x-show="rakuten.savedMapping" class="space-y-6">
                        <div class="bg-green-900/20 border border-green-700 rounded-lg p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-medium text-white mb-2">
                                        <i class="fas fa-check-circle text-green-400 mr-2"></i>Saved Mapping
                                    </h3>
                                    <div class="text-sm text-gray-300 space-y-1">
                                        <div>
                                            <span class="font-medium">Saved:</span>
                                            <span x-text="rakuten.savedMapping?.savedAt"></span>
                                        </div>
                                        <div>
                                            <span class="font-medium">Entries:</span>
                                            <span x-text="rakuten.savedMapping?.data?.length || 0"></span> DID/FC pairs
                                        </div>
                                        <div>
                                            <span class="font-medium">File Size:</span>
                                            <span x-text="rakuten.savedMapping?.fileSize"></span>
                                        </div>
                                    </div>
                                </div>
                                <button @click="deleteSavedMapping()"
                                       class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded transition-colors">
                                    <i class="fas fa-trash mr-2"></i>Delete Mapping
                                </button>
                            </div>
                        </div>

                        <!-- Full Mapping Data -->
                        <div class="bg-gray-700 rounded-lg p-6">
                            <h4 class="text-md font-medium text-white mb-4">
                                <i class="fas fa-table mr-2"></i>Complete Mapping Data
                            </h4>
                            <div class="bg-gray-900 rounded border border-gray-600 overflow-hidden max-h-96 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-800 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">#</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">DID</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 uppercase">FC (Free Call)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-600">
                                        <template x-for="(row, index) in (rakuten.savedMapping?.data || [])" :key="index">
                                            <tr class="hover:bg-gray-800">
                                                <td class="px-4 py-2 text-xs text-gray-400" x-text="index + 1"></td>
                                                <td class="px-4 py-2 text-gray-300 font-mono" x-text="row.DID || row.did"></td>
                                                <td class="px-4 py-2 text-gray-300 font-mono" x-text="row.FC || row.fc"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2 text-xs text-gray-400 text-center">
                                Showing all <span x-text="(rakuten.savedMapping?.data?.length || 0)"></span> DID/FC mappings
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-between">
                            <button @click="downloadMapping()"
                                   class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors">
                                <i class="fas fa-download mr-2"></i>Download as CSV
                            </button>
                            <button @click="switchRakutenPage('upload')"
                                   class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded transition-colors">
                                <i class="fas fa-upload mr-2"></i>Upload New
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documentation Page -->
            <div x-show="rakuten.currentPage === 'docs'" class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-8">
                <div class="mb-8 border-b border-gray-700 pb-6">
                    <h1 class="text-3xl font-bold text-white mb-4">
                        <i class="fas fa-book mr-3 text-blue-400"></i>Documentation
                    </h1>
                    <div class="bg-blue-900/30 border-l-4 border-blue-400 p-4 rounded-r-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-blue-300">
                                    <strong>Version 3.1.1</strong> - CSV Suite Integration by Romain EDIN
                                </p>
                                <p class="text-blue-200 text-sm mt-1">
                                    This tool is provided as-is with no warranty. The developer cannot be held responsible for any issues arising from its use.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Start Guide -->
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-white mb-4">Quick Start</h2>
                    <div class="prose text-gray-300 max-w-none">
                        <ol class="list-decimal list-inside space-y-2">
                            <li>Upload your <strong class="text-white">Raw Data CSV</strong> using drag & drop or click to browse</li>
                            <li>Upload your <strong class="text-white">DID/FC Reference CSV</strong> - see instant preview and validation</li>
                            <li>Watch the <strong class="text-white">real-time progress bar</strong> during processing</li>
                            <li>View <strong class="text-white">interactive charts</strong> and analytics</li>
                            <li>Download the processed CSV file directly</li>
                        </ol>
                    </div>
                </section>

                <!-- Output Fields -->
                <section>
                    <h2 class="text-2xl font-semibold text-white mb-4">Output Fields</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-700 rounded-lg">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-white border-b border-gray-600">Field</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-white border-b border-gray-600">Description</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <tr class="bg-blue-900/30">
                                    <td colspan="2" class="px-4 py-2 text-sm font-semibold text-blue-300">Original Fields</td>
                                </tr>
                                <tr class="bg-gray-800">
                                    <td class="px-4 py-3 text-sm font-medium text-white">account_id, direction, from, to, date_start, date_end, duration</td>
                                    <td class="px-4 py-3 text-sm text-gray-300">Copied from raw data</td>
                                </tr>
                                <tr class="bg-green-900/30">
                                    <td colspan="2" class="px-4 py-2 text-sm font-semibold text-green-300">Generated Fields</td>
                                </tr>
                                <tr class="bg-gray-800">
                                    <td class="px-4 py-3 text-sm font-medium text-white">Originate</td>
                                    <td class="px-4 py-3 text-sm text-gray-300">
                                        <div class="space-y-1">
                                            <div><strong>Classification based on 'from' field:</strong></div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">Anonymous</code>: Contains "Coinline", "Payphone", or starts with "ano"</div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">Toll Free</code>: Starts with "81800"</div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">Mobile</code>: Starts with "8170", "8180", or "8190"</div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">Fixed</code>: Starts with "81" (but not toll free or mobile)</div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">Int'l</code>: All other numbers (default)</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="bg-gray-800">
                                    <td class="px-4 py-3 text-sm font-medium text-white">Terminate</td>
                                    <td class="px-4 py-3 text-sm text-gray-300">
                                        <div class="space-y-1">
                                            <div><strong>Classification based on 'to' field and DID/FC mapping:</strong></div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">TFN Bundle</code>: The 'to' number exists in DID/FC reference file</div>
                                            <div>â€¢ <code class="bg-gray-700 px-1 rounded">Landline</code>: The 'to' number is not found in DID/FC mapping (default)</div>
                                            <div class="text-xs text-gray-400 mt-1">Note: TFN Bundle indicates the call terminated to a Toll-Free Number with an assigned Free Call code</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="bg-gray-800">
                                    <td class="px-4 py-3 text-sm font-medium text-white">FC, FC2, FC3</td>
                                    <td class="px-4 py-3 text-sm text-gray-300">
                                        <div class="space-y-1">
                                            <div><strong>Free Call code assignment from DID/FC mapping:</strong></div>
                                            <div>â€¢ Looks up 'to' field in DID/FC reference file to find associated Free Call codes</div>
                                            <div>â€¢ If multiple FCs exist for same DID, they are distributed across FC, FC2, FC3 columns</div>
                                            <div>â€¢ <strong>Prioritization:</strong> FCs starting with "0120" are always placed in FC column first</div>
                                            <div>â€¢ Non-0120 FCs fill remaining columns (FC2, FC3) or go to FC if no 0120 codes exist</div>
                                            <div>â€¢ Shows <code class="bg-gray-700 px-1 rounded">NA</code> if no mapping found for the DID</div>
                                            <div class="text-xs text-gray-400 mt-1">Example: DID has FCs "0120-123456", "0570-789012", "0120-654321" â†’ FC="0120-123456", FC2="0120-654321", FC3="0570-789012"</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 border-t border-gray-700 pt-6 pb-8">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <div class="text-gray-400 text-sm space-y-2">
                <p class="font-semibold text-gray-300">
                    <i class="fas fa-table mr-2 text-blue-400"></i>CSV Analysis Suite v3.1.1
                </p>
                <p>
                    Report Filtering & Rakuten Security Analysis Tool
                </p>
                <p class="text-xs">
                    Built with <i class="fas fa-heart text-red-500"></i> by Romain EDIN |
                    <a href="/" class="text-blue-400 hover:text-blue-300 transition-colors">Back to Hub</a> |
                    <a href="/changelog.html" class="text-blue-400 hover:text-blue-300 transition-colors">Changelog</a>
                </p>
                <p class="text-xs text-gray-500 mt-3">
                    Last updated: November 21, 2025
                </p>
            </div>
        </div>
    </footer>

    <!-- Include the filter tool JavaScript -->
    <script src="/csv-suite/scripts/filter-tool.js"></script>

    <script>
        // Initialize CSV Filter Tool when filtering tab is active
        let csvTool;
        document.addEventListener('DOMContentLoaded', function() {
            csvTool = new CSVFilterTool();
        });
    </script>
</body>
</html>
